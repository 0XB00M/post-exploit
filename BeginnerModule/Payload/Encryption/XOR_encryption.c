#include <Windows.h>
#include <stdio.h>

#define info(msg,...)		printf("[#] " msg "\n"	, ##__VA_ARGS__);
#define completed(msg,...)	printf("[+] " msg "\n"	, ##__VA_ARGS__);
#define error(msg,...)		printf("[!] " msg "\n"	, ##__VA_ARGS__);

/* XOR ENCRYPTION */
VOID XorByOneKey(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN BYTE bKey) {
	/*
	- pShellcode : Base address of the payload to encrypt
	- sShellcodeSize : The size of the payload
	- bKey : A single arbitrary byte representing the key for encrypting the payload
	*/
	for (size_t i = 0; i < sShellcodeSize; i++) {
		pShellcode[i] = pShellcode[i] ^ bKey;
	}
}

/* Securing the encryption key */
VOID XorByiKeys(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN BYTE bKey) {
	for (size_t i = 0; i < sShellcodeSize; i++) {
		pShellcode[i] = pShellcode[i] ^ (bKey + i);
	}
}

unsigned char shellcode[] = { 0xFC, 0x48, 0x83, 0xE4, 0xF0, 0xE8 };

int main() {

	BYTE bKey = 0x12;

	/* Output actual shellcode */
	printf("[+] Shellcode: ");
	for (int i = 0; i < sizeof(shellcode); i++) {
		printf("%hx", shellcode[i]);
	}
	printf("\n");

	/* start encryption */
	info("Start encryption...");
	//XorByOneKey(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN BYTE bKey)
	XorByOneKey(&shellcode, sizeof(shellcode), bKey);
	printf("[+] Shellcode: ");
	for (int i = 0; i < sizeof(shellcode); i++) {
		printf("%hx", shellcode[i]);
	}
	printf("\n");

	/* start decryption by reapplying the function */
	info("Start decryption...");
	XorByOneKey(&shellcode, sizeof(shellcode), bKey);
	printf("[+] Shellcode: ");
	for (int i = 0; i < sizeof(shellcode); i++) {
		printf("%hx", shellcode[i]);
	}
	printf("\n");


	return 0;
}