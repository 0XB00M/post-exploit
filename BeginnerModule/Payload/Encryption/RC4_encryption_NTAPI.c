#include <Windows.h>
#include <stdio.h>

typedef struct
{
	DWORD	Length;         // Size of the data to encrypt/decrypt
	DWORD	MaximumLength;  // Max size of the data to encrypt/decrypt, although often its the same as Length (USTRING.Length = USTRING.MaximumLength = X)
	PVOID	Buffer;         // The base address of the data to encrypt/decrypt

} USTRING;

typedef NTSTATUS(NTAPI* fnSystemFunction032)(
	struct USTRING* Data,   // Structure of type USTRING that holds information about the buffer to encrypt / decrypt 
	struct USTRING* Key     // Structure of type USTRING that holds information about the key used while encryption / decryption
	);


//Helper function that calls SystemFunction032
//pRc4Key - The RC4 key use to encrypt / decrypt
//pPayloadData - The base address of the buffer to encrypt / decrypt
//dwRc4KeySize - Size of pRc4key(Param 1)
//sPayloadSize - Size of pPayloadData(Param 2)
BOOL Rc4EncryptionViaSystemFunc032(IN PBYTE pRc4Key, IN PBYTE pPayloadData, IN DWORD dwRc4KeySize, IN DWORD sPayloadSize) {

	NTSTATUS STATUS = NULL;

	USTRING Data = {
		.Buffer = pPayloadData,
		.Length = sPayloadSize,
		.MaximumLength = sPayloadSize
	};

	USTRING	Key = {
		.Buffer = pRc4Key,
		.Length = dwRc4KeySize,
		.MaximumLength = dwRc4KeySize
	};

	fnSystemFunction032 SystemFunction032 = (fnSystemFunction032)GetProcAddress(LoadLibraryA("Advapi32"), "SystemFunction032");

	if ((STATUS = SystemFunction032(&Data, &Key)) != 0x0) {
		printf("[!] SystemFunction032 FAILED With Error: 0x%0.8X \n", STATUS);
		return FALSE;
	}

	return TRUE;
}

#define newLine() printf("\n");

int main(void) {

	unsigned char pRc4Key[] = "BOOM123";
	unsigned char pPayloadData[] = {
	0xFC, 0x48, 0x83, 0xE4, 0xF0, 0xE8, 0xC0, 0x00, 0x00, 0x00, 0x41, 0x51,
	0x41, 0x50, 0x52, 0x51, 0x56, 0x48, 0x31, 0xD2, 0x65, 0x48, 0x8B, 0x52,
	0x60, 0x48, 0x8B, 0x52, 0x18, 0x48, 0x8B, 0x52, 0x20, 0x48, 0x8B, 0x72,
	};
	DWORD dwRc4KeySize = sizeof(pRc4Key);
	DWORD dwPayloadSize = sizeof(pPayloadData);

	printf("[#]Shellcdoe: ");
	for (int i = 0; i < sizeof(pPayloadData); i++) {
		printf("%hx", pPayloadData[i]);
	}
	newLine();

	printf("[#]Encrypted: ");
	Rc4EncryptionViaSystemFunc032(pRc4Key, &pPayloadData, dwRc4KeySize, dwPayloadSize);
	for (int i = 0; i < sizeof(pPayloadData); i++) {
		printf("%hx", pPayloadData[i]);
	}
	newLine();

	printf("[#]Decrypted: ");
	Rc4EncryptionViaSystemFunc032(pRc4Key, &pPayloadData, dwRc4KeySize, dwPayloadSize);
	for (int i = 0; i < sizeof(pPayloadData); i++) {
		printf("%hx", pPayloadData[i]);
	}
	newLine();

	return 0;
}
